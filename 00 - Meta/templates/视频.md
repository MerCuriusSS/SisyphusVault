<%*
// 1. 弹出输入框，让你输入B站视频链接（修正prompt用法）
const videoUrl = await tp.system.prompt("请输入B站视频链接");

// 2. 校验链接是否有效，避免匹配失败报错
if (!videoUrl) {
  new Notice("未输入视频链接，模板终止执行");
  return;
}

// 3. 提取BV号（兼容带参数的B站链接，如含?spm_id_from等）
const bvMatch = videoUrl.match(/BV[0-9A-Za-z]+/);
if (!bvMatch) {
  new Notice("未识别到BV号，请检查链接格式");
  return;
}
const bvId = bvMatch[0];

// 4. 拼接API URL（修正：加反引号和引号，避免语法错误）
const apiUrl = `https://api.bilibili.com/x/web-interface/view?bvid=${bvId}`;

try {
  // 5. 请求B站API获取视频信息
  const res = await tp.obsidian.requestUrl({ url: apiUrl });
  const data = res.json.data;

  // 6. 格式化发布时间（兼容不同时区）
  const publishTime = new Date(data.pubdate * 1000).toLocaleString("zh-CN");

  // 7. 输出最终笔记内容（用tR.set()渲染，Templater核心语法）
  tR.set(`
# ${data.title}
- 作者：${data.owner.name}
- 链接：${videoUrl}
- 发布时间：${publishTime}

## 时间戳笔记
- [00:00:00](${videoUrl}#t=0)  此处记录笔记内容
  `);
} catch (err) {
  // 异常处理：API请求失败时提示
  new Notice("获取视频信息失败，请检查网络或链接是否有效");
  console.error("B站API请求错误：", err);
}
%>