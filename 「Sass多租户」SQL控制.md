---
tags:
  - Areas/Coder/javaWeb
  - Areas/Coder/åŸºç¡€åŸç†
category: æŠ€æœ¯
status: åŠ å·¥
project: "[[02 - Projects/åå°ç®¡ç†ç³»ç»Ÿã€ŒRuoyi-Vue-Plusã€|åå°ç®¡ç†ç³»ç»Ÿã€ŒRuoyi-Vue-Plusã€]]"
application: ç§Ÿæˆ·é€»è¾‘éš”ç¦»
source:
---
>**ç¬”è®°ä¸æ˜¯ä¸ºäº†å¤è¿°ä¹¦æœ¬ï¼Œè€Œæ˜¯ä¸ºäº†**â€œå­˜æ¡£å½“ä¸‹çš„è‡ªå·±â€ã€‚å¦‚æœä½ çš„ç¬”è®°é‡Œæ²¡æœ‰ä½ çš„æ€è€ƒç—•è¿¹ã€ç—›è‹¦ç»å†å’Œé€‰æ‹©ç†ç”±**ï¼Œå®ƒå°±åªæ˜¯ä¸€ä»½æ¯«æ— ç”Ÿå‘½åŠ›çš„è¯´æ˜ä¹¦ï¼Œè‡ªç„¶æ— æ³•åœ¨æœªæ¥å”¤é†’ä½ çš„è®¤çŸ¥***


## ğŸ’¥ æ ¸å¿ƒç»“è®º
>æ ¸å¿ƒå®šä¹‰æ˜¯ä»€ä¹ˆ? æ ¸å¿ƒä»·å€¼åœ¨å“ªé‡Œ?

### ğŸŸ£ æ ¸å¿ƒå®šä¹‰ï¼šä»¥ã€Œ**ç§Ÿæˆ·**ã€ï¼ˆç»„ç»‡/æœºæ„ï¼‰ä¸ºå•ä½ï¼Œä½¿ã€Œæ•°æ®ã€æƒé™ã€é…ç½®ã€èµ„æºã€ä½¿ç”¨ç›¸äº’**ç‹¬ç«‹**ï¼Œä½†æ•´ä½“**å¤ç”¨**åŒä¸€å¥—ä»£ç é€»è¾‘å’Œéƒ¨ç½²å®ä¾‹ã€‚
### ğŸŸ£ æ ¸å¿ƒä»·å€¼ï¼šä¸€å¥—ä»£ç ï¼Œå¤šç§Ÿæˆ·ç‹¬ç«‹ä½¿ç”¨ï¼Œéš”ç¦»ä¸”å¤ç”¨ã€‚

## ğŸ”ª æˆ‘çš„è§è§£
>ä»€ä¹ˆè¦è®°å½•å®ƒï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆæˆ‘ä»¥å‰è§£å†³ä¸äº†çš„é—®é¢˜ï¼Ÿ

### ğŸŸ£ ç—›ç‚¹ï¼š
#### 1. äººåŠ›ä¸è¶³ï¼Œç»´æŠ¤æˆæœ¬é«˜æ˜‚ï¼š
- å¤šå®¢æˆ·å¤šéƒ¨ç½²å®ä¾‹ï¼Œèµ„æºä½¿ç”¨ã€ç›‘æ§æˆæœ¬ä¸Šå‡ã€‚
-  ä¸€ä¸ªBUGä¿®å¤éœ€è¦ä¸ºæ‰€æœ‰å®¢æˆ·ç³»ç»Ÿéƒ½ä¿®å¤ä¸€æ¬¡ï¼ŒäººåŠ›ä¸è¶³ã€‚
#### 2. å®šåˆ¶åŒ–éœ€æ±‚éš¾ç®¡ç†ï¼š
- ä¸åŒç”¨æˆ·ç”¨ä¸åŒç³»ç»Ÿç‰ˆæœ¬ï¼Œæ–°åŠŸèƒ½éš¾åŒæ­¥ä¸Šçº¿ã€‚
- ä¸åŒå®šåˆ¶åŒ–éœ€æ±‚è®©ä»£ç åˆ†æ”¯æ³›æ»¥ï¼Œéš¾ç®¡ç†ã€‚

### ğŸŸ£ è§£å†³æ–¹æ¡ˆï¼š
#### 1. ç§Ÿæˆ·idé€»è¾‘éš”ç¦»ï¼Œå…±ç”¨ä¸€å¥—ä»£ç ã€ä¸€å¥—éƒ¨ç½²å®ä¾‹ï¼Œæ‰€æœ‰ç§Ÿæˆ·å…±ç”¨èµ„æºã€‚
#### 2. å…±ç”¨ä¸€å¥—ä»£ç ï¼Œç‰ˆæœ¬ç»Ÿä¸€ã€å®šåˆ¶åŒ–é€»è¾‘é€šè¿‡é…ç½®å®ç°ï¼Œç»´æŠ¤ä»£ç ç»Ÿä¸€ã€‚

## âš¡ï¸ æˆ‘çš„é‡æ„
>å®ƒçš„åº•å±‚é€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå°è¯•ç”¨æœ€ç®€å•çš„ç±»æ¯”è§£é‡Šç»™å¤–è¡Œå¬ï¼‰å®ƒçš„ç»“æ„æ˜¯ä»€ä¹ˆ?

### ğŸŸ£ åº•å±‚é€»è¾‘ï¼šä¸ºå¤§éƒ¨åˆ†ä¸šåŠ¡è¡¨ã€æƒé™é…ç½®è¡¨ç»Ÿä¸€æ·»åŠ `tenant_id`å­—æ®µä½œä¸ºç§Ÿæˆ·æ ‡è¯†ï¼Œåœ¨SQLæ‰§è¡Œå‰é€šè¿‡æ‹¦æˆªå™¨è‡ªåŠ¨åœ¨WHERE å­å¥ä¸­æ·»åŠ åŸºäºç§Ÿæˆ·IDçš„è¿‡æ»¤æ¡ä»¶ã€‚

>**æ·»åŠ tenant_idåŸºå‡†ï¼šè¯¥è¡¨æ•°æ®æ˜¯å¦ã€Œå½’å±äºç‰¹å®šç§Ÿæˆ·ã€ + æ˜¯å¦ã€Œéœ€è¦åœ¨ç§Ÿæˆ·é—´éš”ç¦»ã€**

### ğŸŸ£ ç»“æ„ï¼š

#### 1.æ ¸å¿ƒç»„ä»¶
- ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼ˆtenantContextï¼‰
- ç§Ÿæˆ·æ‹¦æˆªå™¨ï¼ˆtenantInterceptorï¼‰& ç§Ÿæˆ·å¤„ç†å™¨ï¼ˆtenantHandlerï¼‰
- ç”¨æˆ·ç™»å½•çŠ¶æ€ä¸Šä¸‹æ–‡ï¼ˆSaTokenï¼‰
- ç¼“å­˜ç»„ä»¶ï¼ˆRedisï¼‰
#### 2.ã€Œç»„ä»¶ã€æµç¨‹æ¦‚è§ˆå›¾ï¼š[ã€Œå¤šç§Ÿæˆ·éš”ç¦»ã€æµç¨‹æ¦‚è§ˆå›¾](excalidraw/ã€Œå¤šç§Ÿæˆ·éš”ç¦»ã€æµç¨‹æ¦‚è§ˆå›¾.md)
#### 3.ã€Œæ•°æ®æµè½¬ã€æµç¨‹å›¾ï¼š[ã€Œå¤šç§Ÿæˆ·éš”ç¦»ã€æ•°æ®æµè½¬å›¾](excalidraw/ã€Œå¤šç§Ÿæˆ·éš”ç¦»ã€æ•°æ®æµè½¬å›¾.md)

## ğŸš€ å®è·µåº”ç”¨ï¼š

### ğŸŸ£ æœ€å°åŒ–å®è·µï¼š
#### 1.ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼ˆtenantContextï¼‰
```java
public class TenantContext {
    private static ThreadLocal<String> tenantId = new ThreadLocal<>();
    private static ThreadLocal<Boolean> ignore = new ThreadLocal<>();

    public static void setTenantId(String id) {
        tenantId.set(id);
    }

    public static String getTenantId() {
        return tenantId.get();
    }

    public static void setIgnore(Boolean flag) {
        ignore.set(flag);
    }

    public static Boolean isIgnore() {
        return Boolean.TRUE.equals(ignore.get());
    }

    public static void clear() {
        tenantId.remove();
        ignore.remove();
    }
}
```

#### 2. ç§Ÿæˆ·æ‹¦æˆªå™¨ï¼ˆtenantInterceptorï¼‰
```java
@Intercepts({@Signature(type = Executor.class, method = "query", ...)})
public class TenantInterceptor implements Interceptor {

    private List<String> excludeTables = Arrays.asList("sys_tenant");

    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1. è·å–åŸå§‹SQL
        String originalSql = boundSql.getSql();

        // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦ç§Ÿæˆ·éš”ç¦»
        if (TenantContext.isIgnore()) {
            return invocation.proceed(); // å¿½ç•¥æ¨¡å¼
        }

        String tenantId = TenantContext.getTenantId();
        if (tenantId == null) {
            return invocation.proceed(); // æ²¡æœ‰ç§Ÿæˆ·ID
        }

        // 3. æ£€æŸ¥è¡¨æ˜¯å¦åœ¨æ’é™¤åˆ—è¡¨ä¸­
        if (isExcludeTable(originalSql)) {
            return invocation.proceed();
        }

        // 4. æ‹¼æ¥ç§Ÿæˆ·æ¡ä»¶
        String newSql = appendTenantCondition(originalSql, tenantId);

        // 5. æ‰§è¡Œæ–°SQL
        return executeNewSql(newSql);
    }

    private String appendTenantCondition(String sql, String tenantId) {
        if (sql.toUpperCase().contains("WHERE")) {
            return sql + " AND tenant_id = '" + tenantId + "'";
        } else {
            return sql + " WHERE tenant_id = '" + tenantId + "'";
        }
    }
}
```

### ğŸŸ£ ruoyi ç§Ÿæˆ·åŸå®ç°
>ç‰¹ç‚¹ï¼šMyBatis-Plus + Rediséš”ç¦» + ç¼“å­˜éš”ç¦»

#### 1.Rediså…¨å±€æ–°å¢ã€Œç§Ÿæˆ·IDã€å‰ç¼€
```java
@AllArgsConstructor
public class TenantKeyPrefixHandler implements NameMapper {

    private final String keyPrefix;

    @Override
    public String map(String name) {
        // å…¨å±€Keyï¼Œä¸æ·»åŠ ç§Ÿæˆ·å‰ç¼€
        if (StringUtils.contains(name, GlobalConstants.GLOBAL_REDIS_KEY)) {
            return keyPrefix + name;
        }

        // å¿½ç•¥ç§Ÿæˆ·æ¨¡å¼ï¼Œä¸æ·»åŠ ç§Ÿæˆ·å‰ç¼€
        if (TenantHelper.isIgnore()) {
            return keyPrefix + name;
        }

        // è·å–ç§Ÿæˆ·ID
        String tenantId = TenantHelper.getTenantId();
        if (StringUtils.isBlank(tenantId)) {
            return keyPrefix + name;
        }

        // æ·»åŠ ç§Ÿæˆ·å‰ç¼€
        return keyPrefix + tenantId + ":" + name;
    }

    @Override
    public String unmap(String name) {
        // ç§»é™¤å‰ç¼€çš„é€†æ“ä½œ
        String prefix = keyPrefix;
        if (StringUtils.isNotBlank(prefix) && name.startsWith(prefix)) {
            name = name.substring(prefix.length());
        }

        // ç§»é™¤ç§Ÿæˆ·å‰ç¼€
        String tenantId = TenantHelper.getTenantId();
        if (StringUtils.isNotBlank(tenantId) && name.startsWith(tenantId + ":")) {
            return name.substring((tenantId + ":").length());
        }

        return name;
    }
}
```


## â›ª åœºæ™¯è®¾æƒ³
- **åœºæ™¯ A**ï¼šåœ¨å¤„ç† [XXX] ä»£ç é€»è¾‘æ—¶å¯ä»¥æ›¿ä»£åŸæœ‰çš„ [YYY] æ–¹æ³•ã€‚
- **åœºæ™¯ B**ï¼šåœ¨è¿›è¡Œ [ZZZ] å†³ç­–æ—¶ï¼Œç”¨æ¥è§„é¿é€»è¾‘è°¬è¯¯ã€‚