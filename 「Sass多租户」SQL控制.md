---
tags:
  - Areas/Coder/javaWeb
  - Areas/Coder/åŸºç¡€åŸç†
category: æŠ€æœ¯
status: åŠ å·¥
project: "[[02 - Projects/åå°ç®¡ç†ç³»ç»Ÿã€ŒRuoyi-Vue-Plusã€|åå°ç®¡ç†ç³»ç»Ÿã€ŒRuoyi-Vue-Plusã€]]"
application: ç§Ÿæˆ·é€»è¾‘éš”ç¦»
source:
---
>**ç¬”è®°ä¸æ˜¯ä¸ºäº†å¤è¿°ä¹¦æœ¬ï¼Œè€Œæ˜¯ä¸ºäº†**â€œå­˜æ¡£å½“ä¸‹çš„è‡ªå·±â€ã€‚å¦‚æœä½ çš„ç¬”è®°é‡Œæ²¡æœ‰ä½ çš„æ€è€ƒç—•è¿¹ã€ç—›è‹¦ç»å†å’Œé€‰æ‹©ç†ç”±**ï¼Œå®ƒå°±åªæ˜¯ä¸€ä»½æ¯«æ— ç”Ÿå‘½åŠ›çš„è¯´æ˜ä¹¦ï¼Œè‡ªç„¶æ— æ³•åœ¨æœªæ¥å”¤é†’ä½ çš„è®¤çŸ¥***


## ğŸ’¥ æ ¸å¿ƒç»“è®º
>æ ¸å¿ƒå®šä¹‰æ˜¯ä»€ä¹ˆ? æ ¸å¿ƒä»·å€¼åœ¨å“ªé‡Œ?

### ğŸŸ£ æ ¸å¿ƒå®šä¹‰ï¼šä»¥ã€Œ**ç§Ÿæˆ·**ã€ï¼ˆç»„ç»‡/æœºæ„ï¼‰ä¸ºå•ä½ï¼Œä½¿ã€Œæ•°æ®ã€æƒé™ã€é…ç½®ã€èµ„æºã€ä½¿ç”¨ç›¸äº’**ç‹¬ç«‹**ï¼Œä½†æ•´ä½“**å¤ç”¨**åŒä¸€å¥—ä»£ç é€»è¾‘å’Œéƒ¨ç½²å®ä¾‹ã€‚
### ğŸŸ£ æ ¸å¿ƒä»·å€¼ï¼šä¸€å¥—ä»£ç ï¼Œå¤šç§Ÿæˆ·ç‹¬ç«‹ä½¿ç”¨ï¼Œéš”ç¦»ä¸”å¤ç”¨ã€‚

## ğŸ”ª æˆ‘çš„è§è§£
>ä»€ä¹ˆè¦è®°å½•å®ƒï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆæˆ‘ä»¥å‰è§£å†³ä¸äº†çš„é—®é¢˜ï¼Ÿ

### ğŸŸ£ ç—›ç‚¹ï¼š
#### 1. äººåŠ›ä¸è¶³ï¼Œç»´æŠ¤æˆæœ¬é«˜æ˜‚ï¼š
- å¤šå®¢æˆ·å¤šéƒ¨ç½²å®ä¾‹ï¼Œèµ„æºä½¿ç”¨ã€ç›‘æ§æˆæœ¬ä¸Šå‡ã€‚
-  ä¸€ä¸ªBUGä¿®å¤éœ€è¦ä¸ºæ‰€æœ‰å®¢æˆ·ç³»ç»Ÿéƒ½ä¿®å¤ä¸€æ¬¡ï¼ŒäººåŠ›ä¸è¶³ã€‚
#### 2. å®šåˆ¶åŒ–éœ€æ±‚éš¾ç®¡ç†ï¼š
- ä¸åŒç”¨æˆ·ç”¨ä¸åŒç³»ç»Ÿç‰ˆæœ¬ï¼Œæ–°åŠŸèƒ½éš¾åŒæ­¥ä¸Šçº¿ã€‚
- ä¸åŒå®šåˆ¶åŒ–éœ€æ±‚è®©ä»£ç åˆ†æ”¯æ³›æ»¥ï¼Œéš¾ç®¡ç†ã€‚

### ğŸŸ£ è§£å†³æ–¹æ¡ˆï¼š
#### 1. ç§Ÿæˆ·idé€»è¾‘éš”ç¦»ï¼Œå…±ç”¨ä¸€å¥—ä»£ç ã€ä¸€å¥—éƒ¨ç½²å®ä¾‹ï¼Œæ‰€æœ‰ç§Ÿæˆ·å…±ç”¨èµ„æºã€‚
#### 2. å…±ç”¨ä¸€å¥—ä»£ç ï¼Œç‰ˆæœ¬ç»Ÿä¸€ã€å®šåˆ¶åŒ–é€»è¾‘é€šè¿‡é…ç½®å®ç°ï¼Œç»´æŠ¤ä»£ç ç»Ÿä¸€ã€‚

## âš¡ï¸ æˆ‘çš„é‡æ„
>å®ƒçš„åº•å±‚é€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå°è¯•ç”¨æœ€ç®€å•çš„ç±»æ¯”è§£é‡Šç»™å¤–è¡Œå¬ï¼‰å®ƒçš„ç»“æ„æ˜¯ä»€ä¹ˆ?

### ğŸŸ£ åº•å±‚é€»è¾‘ï¼šä¸ºå¤§éƒ¨åˆ†ä¸šåŠ¡è¡¨ã€æƒé™é…ç½®è¡¨ç»Ÿä¸€æ·»åŠ `tenant_id`å­—æ®µä½œä¸ºç§Ÿæˆ·æ ‡è¯†ï¼Œåœ¨SQLæ‰§è¡Œå‰é€šè¿‡æ‹¦æˆªå™¨è‡ªåŠ¨åœ¨WHERE å­å¥ä¸­æ·»åŠ åŸºäºç§Ÿæˆ·IDçš„è¿‡æ»¤æ¡ä»¶ã€‚

>**æ·»åŠ tenant_idåŸºå‡†ï¼šè¯¥è¡¨æ•°æ®æ˜¯å¦ã€Œå½’å±äºç‰¹å®šç§Ÿæˆ·ã€ + æ˜¯å¦ã€Œéœ€è¦åœ¨ç§Ÿæˆ·é—´éš”ç¦»ã€**

### ğŸŸ£ ç»“æ„ï¼š

#### 1.æ ¸å¿ƒç»„ä»¶
- ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼ˆtenantContextï¼‰
- ç§Ÿæˆ·æ‹¦æˆªå™¨ï¼ˆtenantInterceptorï¼‰& ç§Ÿæˆ·å¤„ç†å™¨ï¼ˆtenantHandlerï¼‰
- ç”¨æˆ·ç™»å½•çŠ¶æ€ä¸Šä¸‹æ–‡ï¼ˆSaTokenï¼‰
- ç¼“å­˜ç»„ä»¶ï¼ˆRedisï¼‰
#### 2.ã€Œç»„ä»¶ã€æµç¨‹æ¦‚è§ˆå›¾ï¼š[ã€Œå¤šç§Ÿæˆ·éš”ç¦»ã€æµç¨‹æ¦‚è§ˆå›¾](excalidraw/ã€Œå¤šç§Ÿæˆ·éš”ç¦»ã€æµç¨‹æ¦‚è§ˆå›¾.md)
#### 3.ã€Œæ•°æ®æµè½¬ã€æµç¨‹å›¾ï¼š[ã€Œå¤šç§Ÿæˆ·éš”ç¦»ã€æ•°æ®æµè½¬å›¾](excalidraw/ã€Œå¤šç§Ÿæˆ·éš”ç¦»ã€æ•°æ®æµè½¬å›¾.md)

## ğŸš€ å®è·µåº”ç”¨ï¼š

### ğŸŸ£ æœ€å°åŒ–å®è·µ&ruoyiåŸå®ç°ï¼š [Saaså¤šç§Ÿæˆ·æ ¸å¿ƒæºç ](Saaså¤šç§Ÿæˆ·æ ¸å¿ƒæºç .md)
### ğŸŸ£ ã€Œæœ€å°å®è·µã€ä¸ã€Œruoyiå®ç°ã€æ¯”å¯¹

| ç‰¹æ€§     | æœ€å°åŒ–å®è·µ                     | ruoyiå®ç°              | æ ¸å¿ƒé€»è¾‘                                                                                |
| ------ | ------------------------- | -------------------- | ----------------------------------------------------------------------------------- |
| ç§Ÿæˆ·åˆ‡æ¢   | ä¾èµ–ç™»å½•ç”¨æˆ·ï¼Œåˆ‡æ¢ç”¨æˆ·ä¼šç™»å½•å¤±æ•ˆ          | ä¸ä¾èµ–ç™»å½•æ€ï¼ˆå®šæ—¶ä»»åŠ¡ã€è¶…çº§ç®¡ç†å‘˜åˆ‡æ¢ï¼‰ | 1ï¼‰Redisä¸“é—¨ä¿ç•™åŠ¨æ€ç§Ÿæˆ·ID<br>2ï¼‰Rediså…¨å±€ï¼ˆglobalï¼‰å­˜Tokenï¼Œä¸è·Ÿç§Ÿæˆ·ç»‘å®š<br>3ï¼‰æŸ¥æ•°æ®æ—¶ä¼˜å…ˆç”¨è¿™ä¸ª IDï¼Œä¸ç”¨é‡æ–°ç™»å½•        |
| ä¸šåŠ¡æ•°æ®ç¼“å­˜ | éœ€è¦æ‰‹åŠ¨æ·»åŠ ã€Œç§Ÿæˆ·IDã€å‰ç¼€ä½œç§Ÿæˆ·éš”ç¦»ï¼Œä»¥é˜²ä¸²æ•°æ® | è‡ªåŠ¨æ·»åŠ ã€Œç§Ÿæˆ·IDã€å‰ç¼€         | 1ï¼‰æ¡†æ¶è‡ªåŠ¨ç»™ Key åŠ  â€œç§Ÿæˆ· ID å‰ç¼€â€ï¼Œä¸åŒç§Ÿæˆ·çš„ Key ä¸ä¸€æ ·ï¼›<br>2ï¼‰å¦‚æœæ˜¯å…¨å±€æ•°æ®ï¼ˆæœ‰globalå‰ç¼€ï¼Œå¦‚config/loginï¼‰ï¼Œå°±ä¸åŠ å‰ç¼€ |
| ç‰¹å®šè¡¨å…±äº«  | æ— å·®åˆ«å¯¹è¡¨è¿›è¡Œã€Œç§Ÿæˆ·éš”ç¦»ã€ï¼Œä¸å¯åŒºåˆ†        | å¯å¯¹ç‰¹å®šè¡¨å®ç°ã€Œå¿½ç•¥ç§Ÿæˆ·IDã€      | æŸ¥ç§Ÿæˆ·è¡¨ã€å…¨å±€é…ç½®è¿™äº›å…±äº«æ•°æ®æ—¶ï¼Œå…ˆå¼€ â€œå¿½ç•¥ç§Ÿæˆ·å¼€å…³â€ï¼ˆThreadLocal å­˜ä¸ª trueï¼‰ï¼Œæ¡†æ¶æŸ¥æ•°æ®åº“æ—¶å°±ä¸åŠ  tenant_id æ¡ä»¶ï¼ŒæŸ¥å®Œå†å…³æ‰å¼€å…³   |

### ğŸŸ£ å®æˆ˜æ¼”ç¤º
#### 1.Controllerå±‚
##### æ™®é€šæ¥å£ï¼ˆè‡ªåŠ¨ç§Ÿæˆ·éš”ç¦»ï¼‰
```java
@RestController
@RequestMapping("/demo/product")
@RequiredArgsConstructor
public class ProductController extends BaseController {

    private final IProductService productService;

    // æŸ¥è¯¢åˆ—è¡¨ï¼ˆåªè¿”å›å½“å‰ç§Ÿæˆ·æ•°æ®ï¼‰
    @SaCheckPermission("demo:product:list")
    @GetMapping("/list")
    public TableDataInfo<ProductVo> list(ProductBo bo, PageQuery pageQuery) {
        return productService.queryPageList(bo, pageQuery);
    }

    // æ–°å¢ï¼ˆè‡ªåŠ¨å½’å±å½“å‰ç§Ÿæˆ·ï¼‰
    @SaCheckPermission("demo:product:add")
    @PostMapping()
    public R<Void> add(@Validated @RequestBody ProductBo bo) {
        return toAjax(productService.insert(bo));
    }
}
```

##### ç®¡ç†å‘˜æ¥å£
```java
// æŸ¥è¯¢æ‰€æœ‰ç§Ÿæˆ·æ•°æ®ï¼ˆéœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰
@SaCheckPermission("demo:product:listAll")
@GetMapping("/listAll")
public R<List<ProductVo>> listAll() {
    return R.ok(productService.queryAllTenants());
}

// æŸ¥è¯¢æŒ‡å®šç§Ÿæˆ·æ•°æ®
@SaCheckPermission("demo:product:queryByTenant")
@GetMapping("/tenant/{tenantId}")
public R<List<ProductVo>> queryByTenant(@PathVariable String tenantId) {
    return R.ok(productService.queryByTenantId(tenantId));
}

// è·¨ç§Ÿæˆ·å¤åˆ¶
@SaCheckPermission("demo:product:copy")
@PostMapping("/copy/{id}/to/{tenantId}")
public R<Void> copyToTenant(@PathVariable Long id, @PathVariable String tenantId) {
    return toAjax(productService.copyToTenant(id, tenantId));
}
```

#### 2.Serviceå±‚æ¨¡å¼
##### 1. åŸºç¡€CRUD
```java
@Service
@RequiredArgsConstructor
public class ProductServiceImpl implements IProductService {

    private final ProductMapper baseMapper;

    // æŸ¥è¯¢ï¼ˆè‡ªåŠ¨è¿‡æ»¤å½“å‰ç§Ÿæˆ·ï¼‰
    @Override
    public ProductVo queryById(Long id) {
        return baseMapper.selectVoById(id);
    }

    // æ–°å¢ï¼ˆè‡ªåŠ¨æ³¨å…¥ç§Ÿæˆ·IDï¼‰
    @Override
    public Boolean insert(ProductBo bo) {
        Product product = MapstructUtils.convert(bo, Product.class);
        return baseMapper.insert(product) > 0;
    }

    // æ›´æ–°ï¼ˆè‡ªåŠ¨åº”ç”¨ç§Ÿæˆ·æ¡ä»¶ï¼‰
    @Override
    public Boolean update(ProductBo bo) {
        Product product = MapstructUtils.convert(bo, Product.class);
        return baseMapper.updateById(product) > 0;
    }

    // åˆ é™¤ï¼ˆè‡ªåŠ¨åº”ç”¨ç§Ÿæˆ·æ¡ä»¶ï¼‰
    @Override
    public Boolean delete(Long id) {
        return baseMapper.deleteById(id) > 0;
    }
}
```


##### 2.ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆå¿½ç•¥ç§Ÿæˆ·ï¼‰
```java
// æŸ¥è¯¢æ‰€æœ‰ç§Ÿæˆ·çš„æ•°æ®
@Override
public List<ProductVo> queryAllTenants() {
    return TenantHelper.ignore(() -> {
        return baseMapper.selectVoList(Wrappers.lambdaQuery());
    });
}

// ç»Ÿè®¡æ‰€æœ‰ç§Ÿæˆ·çš„æ•°æ®é‡
@Override
public Long countAllTenants() {
    return TenantHelper.ignore(() -> {
        return baseMapper.selectCount(null);
    });
}

// æ‰¹é‡æ’å…¥ç³»ç»Ÿæ•°æ®ï¼ˆä¸æ³¨å…¥ç§Ÿæˆ·IDï¼‰
@Override
public Boolean batchInsertSystemData(List<SysConfig> configs) {
    TenantHelper.ignore(() -> {
        configMapper.insertBatch(configs);
    });
    return true;
}
```

##### 3. è·¨ç§Ÿæˆ·æ“ä½œï¼ˆåŠ¨æ€åˆ‡æ¢ï¼‰
```java
// æŸ¥è¯¢æŒ‡å®šç§Ÿæˆ·çš„æ•°æ®
@Override
public List<ProductVo> queryByTenantId(String tenantId) {
    return TenantHelper.dynamic(tenantId, () -> {
        return baseMapper.selectVoList(Wrappers.lambdaQuery());
    });
}

// å¤åˆ¶æ•°æ®åˆ°å…¶ä»–ç§Ÿæˆ·
@Override
public Boolean copyToTenant(Long id, String targetTenantId) {
    // æ­¥éª¤1: æŸ¥è¯¢å½“å‰ç§Ÿæˆ·çš„æ•°æ®
    Product source = baseMapper.selectById(id);
    if (source == null) {
        return false;
    }

    // æ­¥éª¤2: åˆ‡æ¢åˆ°ç›®æ ‡ç§Ÿæˆ·æ’å…¥
    return TenantHelper.dynamic(targetTenantId, () -> {
        Product target = new Product();
        BeanUtil.copyProperties(source, target);
        target.setId(null);
        target.setTenantId(targetTenantId);
        return baseMapper.insert(target) > 0;
    });
}

// è·¨ç§Ÿæˆ·æ•°æ®è¿ç§»
@Override
public Boolean migrateData(String fromTenantId, String toTenantId) {
    // æŸ¥è¯¢æºç§Ÿæˆ·æ•°æ®
    List<Product> sourceList = TenantHelper.dynamic(fromTenantId, () -> {
        return baseMapper.selectList(Wrappers.lambdaQuery());
    });

    // æ’å…¥åˆ°ç›®æ ‡ç§Ÿæˆ·
    return TenantHelper.dynamic(toTenantId, () -> {
        for (Product source : sourceList) {
            Product target = new Product();
            BeanUtil.copyProperties(source, target);
            target.setId(null);
            target.setTenantId(toTenantId);
            baseMapper.insert(target);
        }
        return true;
    });
}
```
## â›ª åœºæ™¯è®¾æƒ³

### ğŸŸ£ SaaS CRM ç³»ç»Ÿ
- **ä¸šåŠ¡æµç¨‹**ï¼šä¼ä¸š Aï¼ˆç§Ÿæˆ· 001ï¼‰å’Œä¼ä¸š Bï¼ˆç§Ÿæˆ· 002ï¼‰éƒ½ç”¨è¿™å¥— CRMï¼Œé”€å”®åªèƒ½çœ‹è‡ªå·±ä¼ä¸šçš„å®¢æˆ·æ•°æ®ï¼Œè¶…ç®¡èƒ½çœ‹æ‰€æœ‰ä¼ä¸šæ•°æ®
- **æè¿°**ï¼š
	- **é”€å”®ç™»å½•å**ï¼Œæ¡†æ¶è‡ªåŠ¨ç»™ SQL åŠ  `tenant_id=001`ï¼ŒRedis ç¼“å­˜ Key åŠ  `001:`ï¼Œåªèƒ½çœ‹åˆ°è‡ªå·±ä¼ä¸šçš„å®¢æˆ·ï¼›
	- **è¶…ç®¡ç™»å½•å**ï¼Œé€šè¿‡ `TenantHelper.dynamic("002")` åˆ‡æ¢åˆ°ä¼ä¸š Bï¼Œæ— éœ€é‡æ–°ç™»å½•ï¼Œç›´æ¥æŸ¥çœ‹ B çš„å®¢æˆ·æ•°æ®ï¼›
	- **ç³»ç»Ÿå­—å…¸**ï¼ˆå¦‚å®¢æˆ·ç­‰çº§ï¼‰æ˜¯å…¨å±€é…ç½®ï¼ŒKey ä¸º `global:dict:customer_level`ï¼Œæ‰€æœ‰ç§Ÿæˆ·å…±äº«ï¼Œæ— éœ€é‡å¤ç»´æŠ¤ã€‚

### ğŸŸ£ç”µå•†å¹³å°å•†å®¶åå°ï¼ˆå®šæ—¶ä»»åŠ¡åœºæ™¯ï¼‰
- **ä¸šåŠ¡æµç¨‹**ï¼šæ¯æ—¥å‡Œæ™¨ 2 ç‚¹ï¼Œç³»ç»Ÿè‡ªåŠ¨ç»Ÿè®¡æ¯ä¸ªå•†å®¶ï¼ˆç§Ÿæˆ·ï¼‰çš„è®¢å•æ•°æ®ï¼Œç”ŸæˆæŠ¥è¡¨ã€‚
- **æè¿°**ï¼š
	- å®šæ—¶ä»»åŠ¡æ— ç™»å½•ç”¨æˆ·ï¼Œå…ˆé€šè¿‡ `ignore()` å¼€å…³æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„å•†å®¶åˆ—è¡¨ï¼ˆsys_tenant è¡¨ï¼‰ï¼›
	- éå†æ¯ä¸ªå•†å®¶ï¼Œè°ƒç”¨ `dynamic(tenantId, () -> { ç»Ÿè®¡è®¢å• })`ï¼Œè‡ªåŠ¨ç»™ SQL / ç¼“å­˜åŠ å¯¹åº”ç§Ÿæˆ·å‰ç¼€ï¼›
	- æ‰§è¡Œå®Œæ¯ä¸ªç§Ÿæˆ·åï¼ŒThreadLocal è‡ªåŠ¨æ¸…ç†ç§Ÿæˆ· IDï¼Œé¿å…ä¸‹ä¸€ä¸ªç§Ÿæˆ·ä¸²å€¼ï¼›